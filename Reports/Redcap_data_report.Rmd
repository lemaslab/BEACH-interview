---
title: "Redcap Data report"
author: "Luran M."
date: "September 5, 2019"
output: html_document
---


```{r, include=FALSE}

library(tidyr)
library(dplyr)
library(ggplot2)
library(keyringr)
library(redcapAPI)
library(REDCapR)
library(lubridate)


# **************************************************************************** #
# ***************  Pull data from redcap with api                                              
# **************************************************************************** # 

# Get Redcap API Token
# # https://cran.r-project.org/web/packages/keyringr/vignettes/Avoiding_plain_text_passwords_in_R_with_keyringr.html
credential_label <- "beach_interview_api"
credential_path <- paste(Sys.getenv("USERPROFILE"), '\\DPAPI\\passwords\\', Sys.info()["nodename"], '\\', credential_label, '.txt', sep="")
uri <- "https://redcap.ctsi.ufl.edu/redcap/api/"
beach_token<-decrypt_dpapi_pw(credential_path)
print(beach_token)

# Create connections
rcon <- redcapConnection(url=uri, token=beach_token)


# crc variables
fields <- exportFieldNames(rcon)
desired_fields <- c("record_id","int_phone_pass_fail","encounter_date_int","encounter_type_int","beach_interview_study_encounters_complete","learn_about_study_int")

# events to retain
exportEvents(rcon)
events_to_retain  <- c("beach_interview_phone_screen","beach_interview_study_encounters")

# list of events
exportEvents(rcon)

# list records
#exportRecords(rcon)  I don't know why having this in a report is an issue

# export field names
exportFieldNames(rcon)

# consented records
consent.records.v1=c("BIS001A","BIS002A","BIS003A","BIS004A","BIS005A",
                     "BIS006A","BIS007A","BIS008A","BIS009A","BIS010A",
                     "BIS011A","BIS013A","BIS014A","BIS018A","BIS019A",
                     "BIS022A","BIS023A","BIS024A","BIS025A","BIS026A",
                     "BIS027A","BIS028A","BIS029A","BIS030A","BIS031A",
                     "BIS032A","BIS033A","BIS034A",
                     "PRG001","PRG002","PRG003","PRG004","PRG005",
                     "PRG006","PRG007","PRG008","PRG009","PRG010",
                     "PRG011","PRG012","PRG013","PRG014","PRG015",
                     "PRG016","PRG017","PRG018","PRG020",
                     "156","157","195","196","214","216","224","225","228",
                     "230","234","235","238","239",
                     "240","241","242","245","246","251","255","257","258",
                     "259","260","261","262","265","266","267",
                     "268","269","270","271","273","274","275","276","277",
                     "278","280","281","282","283","286","289",
                     "290","291","293","294","295","296","297","85","88","90")

# pull data
ds_some_rows_v1 <- redcap_read(
  redcap_uri = uri, 
  records= consent.records.v1,
  token      = beach_token, 
  fields     = desired_fields
  
)$data

```


## Figures Plots
```{r, echo=FALSE}
Totals <- ds_some_rows_v1%>%
  select(learn_about_study_int)%>%
  group_by(learn_about_study_int)%>%
  summarize(count=n())%>%
  rename("how did you hear about us?"=learn_about_study_int)

print(Totals)
```


```{r, echo=FALSE}
Encounter_per_Time <- ds_some_rows_v1%>%
  separate(encounter_date_int,c("y","m","d"))%>%
  group_by(learn_about_study_int,m,y)%>%
  summarize(count=n())%>%
  unite("YM",c("y","m"),sep ="-")
    
theme_set(theme_classic())

# distribution of visits each month(histogram)
h <- ggplot(Encounter_per_Time, aes(YM, count)) + scale_fill_brewer(palette = "Spectral")
h + geom_histogram(aes(fill=factor(learn_about_study_int)), stat = "Identity",
                   bins=24,
                   col="black", 
                   size=.1) + # change number of bins
  # geom_density() + #this function is meant to draw a trend line for the graph
  # stat_bin(aes(y=count,label=count),geom="text",vjust=-.5) +   # this will display the total count of each bin
  labs(title="How participants heard of our study monthly", 
       subtitle="from july of 2017-January 2019",
       x="Date(Year-Month)",
       y="Count",
       fill="How did you learn about the study") +
  theme(axis.text.x = element_text(angle=70, vjust =.6))


```
